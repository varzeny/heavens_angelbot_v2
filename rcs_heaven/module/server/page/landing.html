<!DOCTYPE html>
<html>
    <head>
        <title>RCS_Heaven</title>

    </head>

    <body style="width: 98%;">

        <!-- 네비게이션 -->
        <div id="navi" style="border: 4px solid black; padding: 4px;">
            <label>NAVI</label>

            <a href="/"><button>모니터링</button></a>
            <a href="/manageWork"><button>작업 관리</button></a>
            <a href="/manageUnit"><button>유닛 관리</button></a>

        </div>

        <!-- 몸통 -->
        <div style="display: flex;">

            <!-- 층 -->
            <div style="flex: 0.5; border: 4px solid black; padding: 4px;">
                <label>FLOOR</label>
                <hr/>
                <button style="width: 100%;">4 층</button>
                <button style="width: 100%;">3 층</button>
                <button style="width: 100%;">2 층</button>
                <button style="width: 100%;">1 층</button>      
            </div>

            <!-- 지도 -->
            <div id="div_map" style="flex: 9.5; border: 4px solid black; padding: 4px; position: relative;">
                <img id="map" src="static/map/robotcampus4f.png" style="position: relative; width: 100%;">
            </div>


        </div>


        <!-- 하부 -->
        <div style="display: flex; border: 4px solid black; padding: 4px;">

            <div style="flex: 6; border: 4px solid black; padding: 4px;">
                <label>STATUS</label><button id="pb_blackbox" onclick="(async function(){
                    document.getElementById('modal_blackbox').style.display = 'block'

                    try{
                        const response = await fetch('/readTable',{
                            method:'POST',
                            headers:{
                                'Content-Type':'application/json'
                            },
                            body:JSON.stringify({
                                'name':document.getElementById('lbl_name').innerText
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        // console.log(response)
                        const data = await response.json()
                        console.log('$$$$$$$$$$$$$$$$')

                        try{
                            records= data['data'];

                            document.getElementById('div_records').innerHTML = ''
                            for(let r in records){
                                lbl = document.createElement('lbl')
                                lbl.innerText=records[r]
                                document.getElementById('div_records').appendChild(lbl)
                                document.getElementById('div_records').appendChild(
                                    document.createElement('hr')
                                )
                            }

                        }
                        catch{
                            console.log('db불러오기는 성공했는데 그 이후에 문제남')
                        }

                    }
                    catch(error){
                        console.log('운항기록 로드 에러');
                    }
                    
                })()">운항기록</button>
                <hr>
                <label id="lbl_name">name</label><br>
                <label id="lbl_flag_idle">status</label><br>
                <label id="lbl_work">status</label><br>
                <label id="lbl_work_n">status</label><br>
                <label id="lbl_parts">status</label><br>

                <!-- <label id="lbl_idle_cobot">idle_cobot</label><br>
                <label id="lbl_idle_mobot">idle_mobot</label><br>
                <label id="lbl_status">status</label><br>
                <label id="lbl_battery">battery</label><br>
                <label id="lbl_temperature">temperature</label><br>
                <label id="lbl_x">x</label>
                <label id="lbl_y">y</label>
                <label id="lbl_theta">theta</label> -->

                <!-- modal 운항기록 -->
                <div id="modal_blackbox" style="display: none; border: 4px solid black; position: fixed; z-index: 1; left: 71%; top: 1%; background-color: rgb(221, 221, 221);">
                    <label style="display: block; text-align: center;">운항기록</label>
                    <hr>
                    <div id="div_records">기록 없음</div>
                    <hr>
                    <button style="display: block; margin: auto;" onclick="(function(){
                        document.getElementById('modal_blackbox').style.display='none';
                    })();">닫기</button>

                </div>

            </div>

            <div style="flex: 4; border: 4px solid black; padding: 4px;">
                <label>WORK</label>
                <button id="pb_work">작업 관리</button><hr>

                <!-- 진행중인 작업 -->
                <div id="working" style="border: 4px solid black; padding: 4px;">
                
                </div>

                <!-- 작업 모달 -->
                <div id="modal_work" style="display: none; border: 4px solid black; position: fixed; z-index: 1; left: 30%; top: 10%; background-color: rgb(221, 221, 221);">

                    <label style="display: block; text-align: center;">작업 관리창</label>
                    <hr/>

                    <label>작업</label><button onclick="addWork()">작업추가</button>
                    <label>작업이름</label><input id="work_name" type="text">
                    <div id="work_setting" style="border: 4px solid black; margin: 4px;">
                        
                    </div>

                    <hr/>

                    <label>명령목록</label>
                    <div id="cmd_list" style="border: 4px solid black; margin: 4px;">


                        <!-- cobot 명령 -->
                        <div style="border: 4px solid black; margin: 4px;">
                            <label>COBOT Control</label>
                            <button onclick="setWork(
                                {
                                    work_type:'cobotCmd',
                                    work_unit:document.getElementById('cobotCmd_unit').value,
                                    work_cmd:document.getElementById('cobotCmd_value').value
                                }
                            )">명령 추가</button>
                            <hr/>
                            <label>대상</label><input id="cobotCmd_unit" type="text">
                            <label>MODBUS CMD</label><input id="cobotCmd_value" type="text">

                        </div>

                        <!-- mobot 명령 -->
                        <div style="border: 4px solid black; margin: 4px;">
                            <label>MOBOT Control</label>
                            <button onclick="setWork(
                                {
                                    work_type:'mobotCmd',
                                    work_unit:document.getElementById('mobotCmd_unit').value,
                                    work_cmd:document.getElementById('mobotCmd_value').value
                                }
                            )">명령 추가</button>
                            <hr/>
                            <label>대상</label><input id="mobotCmd_unit" type="text">
                            <label>ARCL CMD</label><input id="mobotCmd_value" type="text">
                        </div>

                        <!-- coffee 명령 -->
                        <div style="border: 4px solid black; margin: 4px;">
                            <label>COFFEE Control</label>
                            <button onclick="setWork(
                                {
                                    work_type:'coffeeCmd',
                                    work_unit:document.getElementById('coffeeCmd_unit').value
                                }
                            )">명령 추가</button>
                            <hr>
                            <label>대상</label><input id="coffeeCmd_unit" type="text">

                        </div>

                    </div>

                    <hr/>
                    <button style="display: block; margin: auto;" onclick="(function(){
                        document.getElementById('modal_work').style.display='none';
                    })();">닫기</button>
                    <br>
                    
                </div>


            </div>
        
        </div>

        <div style="display: flex; border: 4px solid black; padding: 4px;">
            <!-- <div style="flex: 3; border: 4px solid black; padding: 4px;">   
                <input type="text" id="input_why" placeholder="why"><br>
                <input type="text" id="input_where" placeholder="where"><br>
                <input type="text" id="input_what" placeholder="what"><br>
                <input type="text" id="input_how" placeholder="how"><br>
                <input type="text" id="input_who" placeholder="who"><br>
                <input type="text" id="input_when" placeholder="when"><br>      
                <button onclick="f2b_json()">MSG send</button>
            </div> -->

            <div id="act_cmd" style="flex: 3; border: 4px solid black; padding: 4px;">   
                <input type="text" id="input_actName" placeholder="actName"><hr/>
                <input type="text" id="input_why" placeholder="why"><br>
                <input type="text" id="input_where" placeholder="where"><br>
                <input type="text" id="input_what" placeholder="what"><br>
                <input type="text" id="input_how" placeholder="how"><br>
                <input type="text" id="input_who" placeholder="who"><br>
                <input type="text" id="input_when" placeholder="when"><br>      
                <button onclick="act2work()">MSG add</button>
            </div>

            <div style="flex: 4; border: 4px solid black; padding: 4px;">   
                <div id="work_cmd">

                </div>
                <hr/>
                <button onclick="f2b_work()">WORK send</button>
            </div>

        </div>


        <script>

            const REALSIZE = 65400;
            const MISX = 33580;
            const MISY = -6000;

            let UNITS = {};
            
            updateData();

            async function f2b_work(){
                const list_work = [];

                // "work_cmd" 요소 내부의 모든 div 요소들을 선택합니다.
                const divs = document.getElementById("work_cmd").querySelectorAll("div");

                // 각 div 요소에 대해 반복을 수행하면서 dataset.msg 값을 배열에 추가합니다.
                divs.forEach(div => {
                    if(div.dataset.msg) {
                        list_work.push(div.dataset.msg);
                    }
                });
                // console.log(list_work);  // 확인용

                /////////////////////////////

                data = {
                    "why": "request",
                    "where": "rcs",
                    "what": "work",
                    "how": list_work,
                    "who": "front",
                    "when": "now"
                    };

                f2b_json(data);
            }

            async function act2work(){
                jsonData = {
                    "name": document.getElementById("input_actName").value,
                    "why": document.getElementById("input_why").value,
                    "where": document.getElementById("input_where").value,
                    "what": document.getElementById("input_what").value,
                    "how": document.getElementById("input_how").value,
                    "who": document.getElementById("input_who").value,
                    "when": document.getElementById("input_when").value
                    };
                console.log(jsonData);


                div = document.createElement("div");
                div.id = jsonData["name"];
                div.innerText = jsonData["name"];
                div.dataset.msg = JSON.stringify(jsonData);
                
                // 버튼 1 생성 및 설정
                let button1 = document.createElement("button");
                button1.innerText = "제거";
                button1.onclick = function() {
                    console.log("버튼 1 클릭됨");
                    this.parentNode.remove();
                };
                div.appendChild(button1);

                // 버튼 2 생성 및 설정
                let button2 = document.createElement("button");
                button2.innerText = "버튼 2";
                button2.onclick = function() {
                    console.log("버튼 2 클릭됨");
                };
                div.appendChild(button2);

                
                document.getElementById("work_cmd").appendChild(div);
            }



            async function f2b_json(inputdata=null) {
                let jsonData;
                
                if (inputdata !== null){
                    jsonData = inputdata
                }else{
                    jsonData = {
                    "why": document.getElementById("input_why").value,
                    "where": document.getElementById("input_where").value,
                    "what": document.getElementById("input_what").value,
                    "how": document.getElementById("input_how").value,
                    "who": document.getElementById("input_who").value,
                    "when": document.getElementById("input_when").value
                    };
                }

                try {
                    // POST 요청을 보냅니다.
                    const response = await fetch("/f2b_json", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(jsonData)
                    });

                    const data = await response.json();
                    console.log("Response:", data);
                } catch (error) {
                    console.error("Error:", error);
                }
            }



            async function clickUnit(){
                console.log("작동")
            }

        
            async function updateData(){////////////////////////////////
                while(1){

                    try{
                        const respone = await fetch("/updateData",{method:"POST"});
                        const jsonData = await respone.json();
                        UNITS = JSON.parse( jsonData );

                        try{
                            // console.log( UNITS );
                            await updateUnits();

                            // for( let name in units ){
                            //     await updateUnit( name, units[name] );
                            // }


                        }
                        catch(error){
                            console.log( "유닛 표시중 오류" );
                        }
                    }

                    catch(error){
                        console.log( "에러발생",error );
                    }

                    finally{
                        await new Promise(resolve => setTimeout( resolve,1000 ));
                    }
                }
                
            }////////////////////////////////////////////////////////////

            async function updateUnits(){
                for (let name in UNITS){
                    console.log( name,"====",UNITS[name] )

                    if( document.getElementById(name) ){
                        // console.log(name)
                        const monitorsize = parseFloat( getComputedStyle( document.getElementById('map') ).width) 

                        const maprate = REALSIZE / monitorsize

                        // console.log( REALSIZE,monitorsize,maprate )

                        // console.log("마커 수정 작업");
                        // console.log( "x", ( unit[2]['location']['x']+MISX )/maprate )
                        // console.log( "y", ( ( unit[2]['location']['y']+MISY )/maprate)*(-1) )


                        img = document.getElementById(name);
                        img.style.left = `${ ( UNITS[name]['location']['x']+MISX )/maprate }px`;
                        img.style.top = `${ ( ( UNITS[name]['location']['y']+MISY )/maprate)*(-1) }px`;
                        img.style.transform = `rotate(${ 360-UNITS[name]['location']['theta'] }deg)`;

                        if(document.getElementById('lbl_name').innerText == name){
                            let data = UNITS[name];
                            document.getElementById('lbl_flag_idle').innerText = data["flag_idle"];
                            document.getElementById('lbl_work').innerText = data["work"];
                            document.getElementById('lbl_work_n').innerText = data["work_n"];
                            document.getElementById('lbl_parts').innerText = JSON.stringify(["parts"]);
                        
                        }

                    }else{
                        console.log( "마커 추가",name );
                        // console.log(name)
                        img = document.createElement( 'img' );
                        img.id = name;
                        if(name[5] != "c"){
                            img.src = "static/icon/angelbot.png";
                            img.style.width = "20px";
                            img.style.height = "20px";
                        }
                        else{
                            img.src = "static/icon/coffee.png";
                            img.style.width = "30px";
                            img.style.height = "30px";
                        }
                        
                        img.style.position = "absolute";
                        img.style.left = "-100px";
                        img.style.top = "-100px";
                        img.style.transform = "rotate(0deg)";
                        // img.setAttribute('data-info', "")
                        img.onclick = await function(){
                            const data = JSON.parse(this.getAttribute('data-info'));

                            document.getElementById('lbl_name').innerText = this.id;
                            
                        }

                        document.getElementById("div_map").appendChild( img );
                    }
                }
            }

            async function updateUnit( name, unit ){/////////////////////////////
                // console.log( name,unit )
                if( document.getElementById(name) ){
                    // console.log(name)
                    const monitorsize = parseFloat( getComputedStyle( document.getElementById('map') ).width) 

                    const maprate = REALSIZE / monitorsize

                    // console.log( REALSIZE,monitorsize,maprate )

                    // console.log("마커 수정 작업");
                    // console.log( "x", ( unit[2]['location']['x']+MISX )/maprate )
                    // console.log( "y", ( ( unit[2]['location']['y']+MISY )/maprate)*(-1) )


                    img = document.getElementById(name);
                    img.style.left = `${ ( unit[2]['location']['x']+MISX )/maprate }px`;
                    img.style.top = `${ ( ( unit[2]['location']['y']+MISY )/maprate)*(-1) }px`;
                    img.style.transform = `rotate(${ 360-unit[2]['location']['theta'] }deg)`;

                    img.setAttribute('data-info', JSON.stringify(unit))
                    // console.log(document.getElementById('lbl_name').innerText)

                    if(document.getElementById('lbl_name').innerText == name){

                        document.getElementById('lbl_idle_cobot').innerText = "idle_cobot : "+unit[0];
                        document.getElementById('lbl_idle_mobot').innerText = "idle_mobot : "+unit[1];
                        document.getElementById('lbl_status').innerText = "status : "+unit[2]['status'];
                        document.getElementById('lbl_battery').innerText = "battery : "+unit[2]['battery'];
                        document.getElementById('lbl_temperature').innerText = "temperature : "+unit[2]['temperature'];
                        document.getElementById('lbl_x').innerText = "x : "+unit[2]['location']['x'];
                        document.getElementById('lbl_y').innerText = "y: "+unit[2]['location']['y'];
                        document.getElementById('lbl_theta').innerText = "theta : "+unit[2]['location']['theta'];
                    }


                    // document.getElementById("div_map").appendChild( img );
                }

                else{
                    console.log( "마커 추가",name );
                    // console.log(name)
                    img = document.createElement( 'img' );
                    img.id = name;
                    if(name[5] != "c"){
                        img.src = "static/icon/angelbot.png";
                        img.style.width = "20px";
                        img.style.height = "20px";
                    }
                    else{
                        img.src = "static/icon/coffee.png";
                        img.style.width = "30px";
                        img.style.height = "30px";
                    }
                       
                    img.style.position = "absolute";
                    img.style.left = "-100px";
                    img.style.top = "-100px";
                    img.style.transform = "rotate(0deg)";
                    // img.setAttribute('data-info', "")
                    img.onclick = await function(){
                        const data = JSON.parse(this.getAttribute('data-info'));

                        document.getElementById('lbl_name').innerText = this.id;
                        
                    }

                    document.getElementById("div_map").appendChild( img );

                }
            }/////////////////////////////////////////////////////////////////



            async function setWork( data ){////////////////////////////
                // console.log( data )

                pb_cmd = document.createElement('button');
                pb_cmd.textContent = JSON.stringify( data )
                pb_cmd.onclick = function(){
                    this.remove();
                }

                document.getElementById('work_setting').appendChild( pb_cmd )
            }///////////////////////////////////////////////////////////



            async function addWork(){////////////////////////////////
                work_name = document.getElementById('work_name').value
                buttons = document.getElementById('work_setting').children;

                var n = 0;
                var data = {
                    "work_name":work_name,
                };
                
                for( let pb of buttons ){
                    data[n++] = pb.textContent
                }

                div_works = document.createElement('div');
                div_works.id = work_name;
                div_works.style.border = "4px solid black;"
                

                // "border: 4px solid black; margin: 4px;";
                lbl = document.createElement('label')
                lbl.innerText = work_name;

                pb_start = document.createElement('button');
                    pb_start.innerText = "start";
                    pb_start.setAttribute('data-json', JSON.stringify( data ))
                    pb_start.onclick = function(){
                        sendWork( this.getAttribute('data-json') )
                    };

                pb_delete = document.createElement('button');
                    pb_delete.innerText = "delete"
                    pb_delete.setAttribute('data-name',work_name)
                    pb_delete.onclick = function(){
                        document.getElementById(this.getAttribute('data-name')).remove();
                    }

                div_works.appendChild( lbl );
                div_works.appendChild( document.createElement('br') );
                div_works.appendChild( pb_start );
                div_works.appendChild( pb_delete );




                document.getElementById('working').appendChild( div_works )
            }/////////////////////////////////////////////////////////////



            async function sendWork( data ){/////////////////////////////

                // console.log( data )

                try{
                    const response = await fetch(
                        '/reqWork',
                        {
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:data
                        }
                    )

                    if( !response.ok ){
                        throw new Error('작업 전송 중 오류');
                    }

                    // console.log( response )

                }catch(error){
                    console.error('Error respone',error);
                }

            }////////////////////////////////////////////////////////

            

            document.getElementById('pb_work').onclick = function(){//////////
                document.getElementById('modal_work').style.display = 'block';
            }//////////////////////////////////////////////////////





        </script>

    </body>
</html>